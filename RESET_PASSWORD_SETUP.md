# üîê Sistema de Reset de Senha - Guia R√°pido

## ‚úÖ O Que Foi Implementado

Sistema **completo** e **pronto para produ√ß√£o** de reset de senha com:

- ‚úÖ **3 endpoints RESTful** (forgot-password, validate-token, reset-password)
- ‚úÖ **Email HTML profissional** com templates bonitos
- ‚úÖ **Integra√ß√£o com Gmail** via Nodemailer
- ‚úÖ **Tokens seguros** com crypto (32 bytes)
- ‚úÖ **Expira√ß√£o de 1 hora** por seguran√ßa
- ‚úÖ **Rate limiting** (5 tentativas/15min)
- ‚úÖ **Auditoria completa** de eventos
- ‚úÖ **Valida√ß√£o de senha** com argon2
- ‚úÖ **Scripts de teste** automatizados

---

## üöÄ Setup R√°pido (3 Minutos)

### **1. Configurar Gmail**

```bash
# 1. Ativar 2FA no Gmail:
#    https://myaccount.google.com/security

# 2. Gerar Senha de App:
#    https://myaccount.google.com/apppasswords
#    ‚Üí Selecionar "Email" e "Outro (nome personalizado)"
#    ‚Üí Copiar senha gerada (16 caracteres)
```

### **2. Configurar Vari√°veis de Ambiente**

Crie/edite `.env.local`:

```env
# Email (Gmail)
EMAIL_USER=seu.email@gmail.com
EMAIL_PASS=xxxx xxxx xxxx xxxx  # Senha de app (16 chars)

# Frontend
FRONTEND_URL=http://localhost:3000

# Database (Supabase)
SUPABASE_URL=https://seu-projeto.supabase.co
SUPABASE_ANON_KEY=sua_chave_anonima
SUPABASE_SERVICE_KEY=sua_chave_service

# JWT
JWT_SECRET=sua_secret_key_min_32_chars
```

### **3. Instalar Depend√™ncias**

```bash
npm install
```

> **Nota:** O `nodemailer` j√° est√° nas depend√™ncias! N√£o precisa instalar nada extra.

### **4. Executar Backend**

```bash
npm run start:dev
```

### **5. Testar Sistema**

#### **Op√ß√£o A: Script Automatizado** (Recomendado)

```bash
# Node.js (funciona em todos OS)
node scripts/test-reset-password.js

# Ou Bash (Linux/Mac)
chmod +x scripts/test-reset-password.sh
./scripts/test-reset-password.sh
```

#### **Op√ß√£o B: Manual com cURL**

```bash
# 1. Solicitar reset
curl -X POST http://localhost:3001/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"seu@email.com"}'

# 2. Verificar email recebido e copiar token

# 3. Validar token
curl -X POST http://localhost:3001/auth/validate-reset-token \
  -H "Content-Type: application/json" \
  -d '{"token":"TOKEN_DO_EMAIL"}'

# 4. Redefinir senha
curl -X POST http://localhost:3001/auth/reset-password \
  -H "Content-Type: application/json" \
  -d '{"token":"TOKEN_DO_EMAIL","newPassword":"NovaSenha123!"}'
```

---

## üìß Email Template

O email enviado possui:

![Email Preview](https://via.placeholder.com/600x400/dc2626/white?text=Email+Preview)

- üé® **Design profissional** com gradiente vermelho
- üî¥ **Bot√£o destacado** "üîë Redefinir Senha"
- ‚è∞ **Alerta de expira√ß√£o** (1 hora)
- üîí **Dicas de seguran√ßa**
- ‚ÑπÔ∏è **Aviso caso n√£o tenha solicitado**

---

## üîå Endpoints da API

### **POST /auth/forgot-password**

Solicita reset de senha e envia email.

**Request:**
```json
{
  "email": "usuario@email.com"
}
```

**Response:**
```json
{
  "message": "Se o e-mail estiver cadastrado, voc√™ receber√° instru√ß√µes para redefinir sua senha."
}
```

**Status Codes:**
- `200` - Sucesso (sempre, por seguran√ßa)
- `429` - Rate limit excedido

---

### **POST /auth/validate-reset-token** ‚≠ê NOVO

Valida se um token √© v√°lido antes de mostrar formul√°rio.

**Request:**
```json
{
  "token": "abc123..."
}
```

**Response (V√°lido):**
```json
{
  "valid": true,
  "message": "Token v√°lido"
}
```

**Response (Inv√°lido):**
```json
{
  "valid": false,
  "message": "Token inv√°lido"
}
```

**Response (Expirado):**
```json
{
  "valid": false,
  "message": "Token expirado. Solicite um novo reset de senha."
}
```

**Status Codes:**
- `200` - Sempre (checar campo `valid`)

---

### **POST /auth/reset-password**

Redefine a senha usando token v√°lido.

**Request:**
```json
{
  "token": "abc123...",
  "newPassword": "MinhaNovaSenh@123"
}
```

**Response:**
```json
{
  "message": "Senha redefinida com sucesso."
}
```

**Status Codes:**
- `200` - Senha redefinida
- `400` - Token inv√°lido/expirado ou senha fraca

---

## üîí Seguran√ßa

### **Tokens**
- Gerados com `crypto.randomBytes(32)` (64 chars hex)
- √önicos e imposs√≠veis de adivinhar
- Expiram em **1 hora**
- Marcados como `used: true` ap√≥s uso

### **Rate Limiting**
- **5 tentativas** por IP em 15 minutos
- Evita spam de emails
- Aplicado nos endpoints cr√≠ticos

### **Privacidade**
- Sempre retorna mensagem gen√©rica
- N√£o revela se email existe no sistema
- Evita enumera√ß√£o de usu√°rios

### **Hash de Senha**
- Usa **argon2** (mais seguro que bcrypt)
- Salt autom√°tico
- Configur√°vel no `password.util.ts`

---

## üåê Integra√ß√£o com Frontend

### **Exemplo React/Next.js**

#### **P√°gina: Esqueci Minha Senha**

```typescript
// app/auth/forgot-password/page.tsx
'use client';

import { useState } from 'react';

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch('http://localhost:3001/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();
      setMessage(data.message);
    } catch (error) {
      setMessage('Erro ao solicitar reset. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        placeholder="Seu e-mail"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        required
      />
      <button type="submit" disabled={loading}>
        {loading ? 'Enviando...' : 'Enviar Email'}
      </button>
      {message && <p>{message}</p>}
    </form>
  );
}
```

#### **P√°gina: Redefinir Senha**

```typescript
// app/auth/reset-password/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';

export default function ResetPasswordPage() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const [token, setToken] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [validating, setValidating] = useState(true);
  const [isValidToken, setIsValidToken] = useState(false);
  const [message, setMessage] = useState('');

  useEffect(() => {
    const tokenFromUrl = searchParams.get('token');
    if (!tokenFromUrl) {
      router.push('/auth/forgot-password');
      return;
    }
    
    setToken(tokenFromUrl);
    validateToken(tokenFromUrl);
  }, [searchParams]);

  const validateToken = async (token: string) => {
    try {
      const response = await fetch('http://localhost:3001/auth/validate-reset-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      const data = await response.json();
      setIsValidToken(data.valid);
      
      if (!data.valid) {
        setMessage(data.message || 'Token inv√°lido');
      }
    } catch (error) {
      setIsValidToken(false);
      setMessage('Erro ao validar token');
    } finally {
      setValidating(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch('http://localhost:3001/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword }),
      });

      const data = await response.json();

      if (response.ok) {
        setMessage('Senha redefinida com sucesso!');
        setTimeout(() => router.push('/auth/login'), 2000);
      } else {
        setMessage(data.message || 'Erro ao redefinir senha');
      }
    } catch (error) {
      setMessage('Erro ao redefinir senha. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  if (validating) {
    return <div>Validando token...</div>;
  }

  if (!isValidToken) {
    return (
      <div>
        <p>{message}</p>
        <button onClick={() => router.push('/auth/forgot-password')}>
          Solicitar Novo Reset
        </button>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="password"
        placeholder="Nova senha"
        value={newPassword}
        onChange={(e) => setNewPassword(e.target.value)}
        minLength={4}
        required
      />
      <button type="submit" disabled={loading}>
        {loading ? 'Redefinindo...' : 'Redefinir Senha'}
      </button>
      {message && <p>{message}</p>}
    </form>
  );
}
```

---

## üöÄ Deploy (Railway)

### **Configurar Vari√°veis de Ambiente**

1. Acesse seu projeto no Railway
2. V√° em **Settings ‚Üí Variables**
3. Adicione:

```
EMAIL_USER = seu.email@gmail.com
EMAIL_PASS = xxxx xxxx xxxx xxxx
FRONTEND_URL = https://seu-frontend.netlify.app
```

4. **Redeploy** autom√°tico

### **Verificar Health Check**

```bash
curl https://seu-backend.railway.app/health
```

**Resposta esperada:**
```json
{
  "status": "ok",
  "timestamp": "2025-01-20T10:30:00.000Z",
  "uptime": 123.456
}
```

---

## üêõ Troubleshooting

### **Problema: Email n√£o chega**

**Solu√ß√µes:**
1. ‚úÖ Verificar pasta de **Spam**
2. ‚úÖ Conferir se `EMAIL_USER` e `EMAIL_PASS` est√£o corretos
3. ‚úÖ Verificar logs do servidor: `console.log` mostra "Email enviado"
4. ‚úÖ Confirmar que **2FA est√° ativado** no Gmail
5. ‚úÖ Verificar **quota do Gmail** (500 emails/dia gr√°tis)

### **Problema: "Token inv√°lido"**

**Solu√ß√µes:**
1. ‚úÖ Usar `/auth/validate-reset-token` para debugar
2. ‚úÖ Verificar se token no email == token na requisi√ß√£o
3. ‚úÖ Verificar tabela `password_reset_tokens` no Supabase

### **Problema: "Token expirado"**

**Solu√ß√£o:**
- Tokens expiram em **1 hora**
- Solicitar novo reset de senha

### **Problema: Servidor n√£o conecta com Gmail**

**Verificar:**
```bash
# Testar autentica√ß√£o do Gmail
node -e "
const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransporter({
  service: 'gmail',
  auth: {
    user: 'seu@gmail.com',
    pass: 'sua_senha_app'
  }
});
transporter.verify((err, success) => {
  if (err) console.error('‚ùå Erro:', err);
  else console.log('‚úÖ Gmail conectado!');
});
"
```

---

## üìö Documenta√ß√£o Completa

- üìñ [Setup Detalhado](./docs/EMAIL_SETUP.md)
- üß™ [Scripts de Teste](./scripts/)
- üîê [Swagger Docs](http://localhost:3001/api/docs)

---

## ‚úÖ Checklist de Produ√ß√£o

Antes de colocar em produ√ß√£o:

- [ ] ‚úÖ Configurar `EMAIL_USER` e `EMAIL_PASS` no Railway
- [ ] ‚úÖ Configurar `FRONTEND_URL` correto
- [ ] ‚úÖ Testar endpoints em ambiente de staging
- [ ] ‚úÖ Verificar se emails chegam corretamente
- [ ] ‚úÖ Validar templates de email em diferentes clients
- [ ] ‚úÖ Configurar monitoramento de envio de emails
- [ ] ‚úÖ Documentar processo para equipe

---

## üéØ Pronto para Uso!

O sistema est√° **100% funcional** e pronto para produ√ß√£o!

**Pr√≥ximos passos:**
1. Configure as vari√°veis de ambiente
2. Execute os scripts de teste
3. Deploy no Railway
4. üöÄ Sistema funcionando!

---

**Desenvolvido com ‚ù§Ô∏è para Bravo.Bet**

